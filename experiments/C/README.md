# C(t) 局部语义聚类密度计算验证程序

## 📋 概述

`C_test.py` 是用于验证 C(t) 局部语义聚类密度计算正确性的测试程序。该程序使用真实的中文句子和 LLM 提取的特征，对 `c_t_calculator.py` 中的 C(t) 计算函数进行全面验证。

## 🎯 主要功能

### 1. 单次计算验证
- 对句子中的每个 token 逐个计算 C(t) 值
- 显示详细的计算过程和中间结果
- 验证 M(t) 形态匹配值的计算

### 2. 批量计算验证
- 使用 `compute_c_t_batch` 函数进行批量计算
- 验证单次计算与批量计算的一致性

### 3. 多义词分析
- 针对常见中文多义词进行专门分析
- 展示 C(t) 和 M(t) 值的关系

### 4. 结果合理性验证
- 检查 C(t) 值范围是否合理
- 验证所有值均为正数
- 确保数值在经验范围内

## 📊 C(t) 计算公式

```
C(t) = [N_eff(t) / (V_local(t) + ε)] × γ(M(t))
```

其中：
- **N_eff(t)**: 语义相似度 ≥ θ 的有效向量数
- **V_local(t)**: 局部子空间体积（协方差椭圆体）
- **γ(M(t))**: 形态修正因子 = 1 + α × M(t)
- **M(t)**: 形态匹配度 = cos(h(t), Φ(m(t)))

## 🔧 依赖要求

### Python 包
- `torch` - PyTorch 深度学习框架
- `numpy` - 数值计算
- `transformers` - Hugging Face 模型库

### 项目依赖
- `llm_hidden_extractor.py` - LLM 特征提取器
- `c_t_calculator.py` - C(t) 计算核心函数
- `m_t_calculator.py` - M(t) 形态匹配计算器

### 硬件要求
- 支持 CUDA 的 GPU（推荐）或 CPU
- 至少 4GB RAM

## 🚀 使用方法

### 基本运行
```bash
cd experiments/C
python C_test.py
```

### 预期输出
```
============================================================
C(t) 局部语义聚类密度计算验证
============================================================
测试句子: 他打篮球打得很好

正在提取LLM特征...
✓ 成功提取特征
  - Token数量: 12
  - Hidden维度: 896

原始句子: 他打篮球打得很好
解码文本: 他打篮球打得很好
分词结果: ['[CLS]', '他', '打', '篮', '球', '打', '得', '很', '好', '[SEP]']

计算C(t)局部语义聚类密度...
说明：
- C(t) = [N_eff(t) / (V_local(t)+eps)] * γ(M(t))
- N_eff(t): 语义相似度 >= θ 的有效向量数
- V_local(t): 局部子空间体积（协方差椭圆体）
- γ(M(t)): 形态修正因子
----------------------------------------

Token '[CLS]' (位置0):
  C(t) = 0.123456
  M(t) = 0.789012

Token '他' (位置1):
  C(t) = 0.234567
  M(t) = 0.345678
...
```

## ⚙️ 参数配置

### 计算参数
- `middle_layer_idx=12`: 使用 LLM 第12层特征
- `k=3`: 上下文窗口大小
- `theta=0.5`: 语义相似度阈值
- `alpha=0.4`: 形态修正因子权重

### 测试句子
当前包含以下测试句子：
- `"他打篮球打得很好"` - 包含多义词"打"
- `"他打了小明一下"` - "打"的不同义项
- `"这个计划行不通"` - 多义词"行"

## 📈 输出解释

### 基本信息
- **Token数量**: 句子被分词后的token总数
- **Hidden维度**: LLM隐藏层特征维度

### 每个Token的结果
- **C(t)**: 局部语义聚类密度值
- **M(t)**: 形态匹配度 (0-1之间)

### 验证结果
- **C(t)值范围**: 所有C(t)值的最小值和最大值
- **一致性检查**: 单次计算 vs 批量计算结果是否一致
- **合理性检查**: 值是否在预期范围内

### 多义词分析
针对句子中的多义词，单独展示其C(t)和M(t)值，有助于理解形态修正对多义消歧的影响。

## 🔍 验证要点

### ✅ 正确性验证
- [ ] C(t) 值均为正数
- [ ] M(t) 值在 [0,1] 范围内
- [ ] 单次和批量计算结果一致

### ✅ 合理性验证
- [ ] C(t) 值在合理范围内 (通常 0.1-10)
- [ ] 多义词的C(t)值反映语义复杂度
- [ ] 形态修正因子γ(M(t))正确应用

## 🐛 常见问题

### 特征提取失败
**问题**: `特征提取失败: CUDA out of memory`
**解决**: 减少 `middle_layer_idx` 或使用 CPU 模式

### 形态计算失败
**问题**: `计算token失败: 形态特征提取错误`
**解决**: 检查 `m_t_calculator.py` 的形态嵌入模型是否正确加载

### 数值异常
**问题**: C(t) 值过大或为负数
**解决**: 检查 `theta` 和 `alpha` 参数设置是否合理

## 📝 注意事项

1. **计算时间**: 首次运行需要加载LLM模型，可能需要几分钟
2. **内存使用**: 大模型特征提取需要较多内存
3. **中文显示**: 确保终端支持UTF-8编码以正确显示中文
4. **参数调优**: 不同任务可能需要调整 `theta` 和 `alpha` 参数

## 🔗 相关文件

- `c_t_calculator.py` - C(t) 计算核心实现
- `m_t_calculator.py` - M(t) 形态匹配计算
- `llm_hidden_extractor.py` - LLM 特征提取
- `C_alpha_ablation_experiment.py` - Alpha 参数消融实验

## 📊 实验结果示例

```
验证结果合理性:
----------------------------------------
✓ C(t)值范围: [0.023456, 2.345678]
✓ 所有C(t)为正值: True
✓ C(t)值合理性: True
✓ 单次vs批量计算一致性: True

多义词C(t)分析:
  '打': C(t)=1.234567, M(t)=0.876543
  '好': C(t)=0.345678, M(t)=0.654321
```

---

*该测试程序用于验证 C(t) 局部语义聚类密度计算的正确性，是多义性熵 H(t) 计算系统的重要验证工具。*